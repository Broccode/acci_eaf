# Story 4.1.1: Implement EafPostgresEventStorageEngine Core Logic

## Status: To Do

## Story
- **As a** Developer
- **I want** to create the `EafPostgresEventStorageEngine` class that implements Axon's `EventStorageEngine` interface
- **so that** Axon can delegate event persistence to our custom EAF Event Store SDK.

## Acceptance Criteria
1. A new class, `EafPostgresEventStorageEngine`, is created in the `eaf-eventsourcing-sdk` module.
2. The class implements the `org.axonframework.eventsourcing.eventstore.EventStorageEngine` interface.
3. The implementation correctly delegates calls for `appendEvents`, `storeSnapshot`, and `readEvents` to the existing `EafEventStoreSdk`.
4. The adapter properly translates between Axon's `EventMessage` and the SDK's internal `StoredEvent` format.
5. All database operations are wrapped in appropriate exception handling that translates SDK-specific exceptions into Axon-specific exceptions (e.g., `ConcurrencyException`).

## Tasks / Subtasks

- [ ] **Task 1: Create EafPostgresEventStorageEngine Class Structure** (AC: 1, 2)
  - [ ] Create `EafPostgresEventStorageEngine.kt` in `libs/eaf-eventsourcing-sdk/src/main/kotlin/com/axians/eaf/eventsourcing/axon`
  - [ ] Implement `org.axonframework.eventsourcing.eventstore.EventStorageEngine` interface
  - [ ] Add constructor dependencies for `EafEventStoreSdk` and `TenantContextHolder`
  - [ ] Add `@Component` annotation for Spring Boot auto-configuration

- [ ] **Task 2: Implement Core EventStorageEngine Methods** (AC: 3)
  - [ ] Implement `appendEvents(streamIdentifier, events)` method delegating to `EafEventStoreSdk.append`
  - [ ] Implement `storeSnapshot(snapshot)` method delegating to `EafEventStoreSdk.storeSnapshot`
  - [ ] Implement `readEvents(identifier, firstSequenceNumber)` for aggregate event loading
  - [ ] Implement `readEvents(trackingToken, mayBlock)` for event streaming with `TrackingEventProcessor`
  - [ ] Implement `createTailToken()` and `createHeadToken()` for event streaming boundaries

- [ ] **Task 3: Implement Event Message Translation** (AC: 4)
  - [ ] Create `AxonEventMessageMapper` utility class for bidirectional conversion
  - [ ] Implement `DomainEventMessage -> StoredEvent` mapping (serialize payload/metadata to JSON)
  - [ ] Implement `StoredEvent -> DomainEventMessage` mapping (deserialize from JSON)
  - [ ] Handle event metadata preservation (timestamps, aggregate version, correlation data)
  - [ ] Ensure proper handling of snapshot events vs domain events

- [ ] **Task 4: Exception Handling and Translation** (AC: 5)
  - [ ] Wrap `EafEventStoreSdk.append()` calls with try-catch for optimistic locking conflicts
  - [ ] Translate `OptimisticLockException` to Axon's `ConcurrencyException`
  - [ ] Translate `SQLException` to appropriate Axon `EventStoreException`
  - [ ] Add logging for all exception scenarios
  - [ ] Ensure tenant context validation in all operations

- [ ] **Task 5: Configuration and Spring Integration**
  - [ ] Add Axon dependencies to `libs/eaf-eventsourcing-sdk/build.gradle.kts`
  - [ ] Create `AxonEventSourcingConfiguration.kt` Spring configuration class
  - [ ] Register `EafPostgresEventStorageEngine` as primary `EventStorageEngine` bean
  - [ ] Configure Axon to use custom storage engine in application configuration

## Dev Technical Guidance

- **Module Location**: `libs/eaf-eventsourcing-sdk/src/main/kotlin/com/axians/eaf/eventsourcing/axon/`
- **Dependencies Required**: Add to `libs/eaf-eventsourcing-sdk/build.gradle.kts`:
  ```kotlin
  implementation(libs.axon.eventsourcing)
  implementation(libs.axon.spring.boot.starter)
  implementation(libs.jackson.module.kotlin)
  ```
- **Axon Framework Version**: Use Axon Framework 4.9.x (latest stable) - add to `gradle/libs.versions.toml`
- **Integration Points**:
  - Must integrate with existing `EafEventStoreSdk` from `eaf-eventsourcing-sdk`
  - Requires `TenantContextHolder` implementation (Story 4.1.3 dependency)
  - Uses `GlobalSequenceTrackingToken` (Story 4.1.2 dependency)
- **Hexagonal Architecture**: Place in `infrastructure/axon` package within the eventsourcing SDK
- **Event Serialization**: Use Jackson with Kotlin module for JSON serialization of event payloads and metadata
- **Configuration Pattern**: Follow Spring Boot auto-configuration pattern with `@ConditionalOnClass(AxonFramework::class)`
- **Tenant Isolation**: Every database query must include tenant_id filter from `TenantContextHolder.getCurrentTenantId()`

## Testing Guidance

- **Objective**: Verify correct delegation to `EafEventStoreSdk`, proper event message translation, and exception handling scenarios
- **Key Test Scenarios**:
  - **Unit Tests with MockK**:
    - Mock `EafEventStoreSdk` and verify delegation calls with correct parameters
    - Test event message translation (Axon EventMessage ↔ StoredEvent) with various event types
    - Test exception translation (OptimisticLockException → ConcurrencyException)
    - Test tenant context integration and validation
  - **Integration Tests with Testcontainers**:
    - End-to-end event persistence and retrieval through Axon framework
    - Multi-tenant data isolation verification
    - Concurrent event appending scenarios (optimistic locking)
    - Event streaming with TrackingEventProcessor using custom tokens
  - **Performance Tests**:
    - Measure event append latency compared to direct SDK usage
    - Verify streaming performance with large event volumes
- **Success Criteria**: 
  - All unit tests pass with >95% code coverage
  - Integration tests demonstrate successful event persistence and retrieval
  - No tenant data leakage in multi-tenant scenarios
  - Exception handling maintains Axon contract expectations
- **Tools**: JUnit 5, MockK, Testcontainers (PostgreSQL), Axon Test Fixtures
